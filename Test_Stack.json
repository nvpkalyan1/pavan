{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "OTRS Testing Instance with AutoScaling",
  
  "Parameters": {
    "VpcId" : {
    "Type" : "AWS::EC2::VPC::Id",
    "Description" : "VpcId of your existing Virtual Private Cloud (VPC)",
	"Default" : "vpc-c12349a4",
    "ConstraintDescription" : "must be the VPC Id of an existing Virtual Private Cloud."
    },
	"keyName": {
    "Description": "The key pair to use",
    "Type": "String",
	"Default": "APP_APP_DEV_17-1"
	 },
    "instanceType" : {
    "Description": "The Instance type to use",
    "Type": "String",
	"AllowedValues" : [ "t1.micro", "t2.nano", "t2.micro", "t2.small", "t2.medium", "t2.large", "m1.small", "m1.medium", "m1.large", "m1.xlarge", "m2.xlarge", "m2.2xlarge", "m2.4xlarge", "m3.medium", "m3.large", "m3.xlarge", "m3.2xlarge", "m4.large", "m4.xlarge", "m4.2xlarge", "m4.4xlarge", "m4.10xlarge", "c1.medium", "c1.xlarge", "c3.large", "c3.xlarge", "c3.2xlarge", "c3.4xlarge", "c3.8xlarge", "c4.large", "c4.xlarge", "c4.2xlarge", "c4.4xlarge", "c4.8xlarge", "g2.2xlarge", "g2.8xlarge", "r3.large", "r3.xlarge", "r3.2xlarge", "r3.4xlarge", "r3.8xlarge", "i2.xlarge", "i2.2xlarge", "i2.4xlarge", "i2.8xlarge", "d2.xlarge", "d2.2xlarge", "d2.4xlarge", "d2.8xlarge", "hi1.4xlarge", "hs1.8xlarge", "cr1.8xlarge", "cc2.8xlarge", "cg1.4xlarge"]
,
	"Default": "t2.medium"
    },
	"securityGroups": {
    "Description": "Security Groups to associate with Launch Configuration",
    "Type": "List<AWS::EC2::SecurityGroup::Id>",
	"Default": "sg-123cf657, sg-0987fb05, sg-5a98d897, sg-7599d123"
    },
	"devAZs": {
    "Type": "List<AWS::EC2::AvailabilityZone::Name>",
	"Description": "Name of the first availability zone in which the servers will be created.",
    "Default": "us-east-1b, us-east-1c"
    },
	"asVpcSubnets": {
    "Description": "The Subnet(s) to use for the autoscaling group",
    "Type": "List<AWS::EC2::Subnet::Id>",
	"Default": "subnet-1d2e7890, subnet-0df4567a"
    },
	"instanceProfile": {
    "Description": "IAM Role to be applied for the Instance",
    "Type" : "String",
	"Default" : "APP_OTRS"
    },
	"healthUrl": {
      "Description": "The health check URL to use for the ELB (format: [PROTOCOL]:[PORT]/[PATH])",
      "Type": "String",
      "Default": "HTTPS:443/health"
    }
},
	
"Mappings" : {
    "AWSInstanceType2Arch" : {
      "t1.micro"    : { "Arch" : "PV64"   },
      "t2.nano"     : { "Arch" : "HVM64"  },
      "t2.micro"    : { "Arch" : "HVM64"  },
      "t2.small"    : { "Arch" : "HVM64"  },
      "t2.medium"   : { "Arch" : "HVM64"  },
      "t2.large"    : { "Arch" : "HVM64"  },
      "m1.small"    : { "Arch" : "PV64"   },
      "m1.medium"   : { "Arch" : "PV64"   },
      "m1.large"    : { "Arch" : "PV64"   },
      "m1.xlarge"   : { "Arch" : "PV64"   },
      "m2.xlarge"   : { "Arch" : "PV64"   },
      "m2.2xlarge"  : { "Arch" : "PV64"   },
      "m2.4xlarge"  : { "Arch" : "PV64"   },
      "m3.medium"   : { "Arch" : "HVM64"  },
      "m3.large"    : { "Arch" : "HVM64"  },
      "m3.xlarge"   : { "Arch" : "HVM64"  },
      "m3.2xlarge"  : { "Arch" : "HVM64"  },
      "m4.large"    : { "Arch" : "HVM64"  },
      "m4.xlarge"   : { "Arch" : "HVM64"  },
      "m4.2xlarge"  : { "Arch" : "HVM64"  },
      "m4.4xlarge"  : { "Arch" : "HVM64"  },
      "m4.10xlarge" : { "Arch" : "HVM64"  },
      "c1.medium"   : { "Arch" : "PV64"   },
      "c1.xlarge"   : { "Arch" : "PV64"   },
      "c3.large"    : { "Arch" : "HVM64"  },
      "c3.xlarge"   : { "Arch" : "HVM64"  },
      "c3.2xlarge"  : { "Arch" : "HVM64"  },
      "c3.4xlarge"  : { "Arch" : "HVM64"  },
      "c3.8xlarge"  : { "Arch" : "HVM64"  },
      "c4.large"    : { "Arch" : "HVM64"  },
      "c4.xlarge"   : { "Arch" : "HVM64"  },
      "c4.2xlarge"  : { "Arch" : "HVM64"  },
      "c4.4xlarge"  : { "Arch" : "HVM64"  },
      "c4.8xlarge"  : { "Arch" : "HVM64"  },
      "g2.2xlarge"  : { "Arch" : "HVMG2"  },
      "g2.8xlarge"  : { "Arch" : "HVMG2"  },
      "r3.large"    : { "Arch" : "HVM64"  },
      "r3.xlarge"   : { "Arch" : "HVM64"  },
      "r3.2xlarge"  : { "Arch" : "HVM64"  },
      "r3.4xlarge"  : { "Arch" : "HVM64"  },
      "r3.8xlarge"  : { "Arch" : "HVM64"  },
      "i2.xlarge"   : { "Arch" : "HVM64"  },
      "i2.2xlarge"  : { "Arch" : "HVM64"  },
      "i2.4xlarge"  : { "Arch" : "HVM64"  },
      "i2.8xlarge"  : { "Arch" : "HVM64"  },
      "d2.xlarge"   : { "Arch" : "HVM64"  },
      "d2.2xlarge"  : { "Arch" : "HVM64"  },
      "d2.4xlarge"  : { "Arch" : "HVM64"  },
      "d2.8xlarge"  : { "Arch" : "HVM64"  },
      "hi1.4xlarge" : { "Arch" : "HVM64"  },
      "hs1.8xlarge" : { "Arch" : "HVM64"  },
      "cr1.8xlarge" : { "Arch" : "HVM64"  },
      "cc2.8xlarge" : { "Arch" : "HVM64"  }
    },
	
	"AWSRegionArch2AMI" : {
      "us-east-1"        : {"PV32" : "ami-2cf0f13b", "HVM64" : "ami-2cf0f13b"}
    }
},		
		"Resources": {
		"OTRSScalingGroup" : {
			"Type" : "AWS::AutoScaling::AutoScalingGroup",
			"Properties" : {
			"AvailabilityZones" : { "Ref" : "devAZs" },
			"VPCZoneIdentifier": { "Ref": "asVpcSubnets" },
		"LaunchConfigurationName" : { "Ref" : "LaunchConfig" },
			"MinSize" : "2",
			"MaxSize" : "3",
			"Cooldown" : "300",        
			"DesiredCapacity" : "2",
				"Tags" : [ 
					{"Key" : "Name", "Value" : "AWSLXOTRS-SMED01" , "PropagateAtLaunch" : "true" }, 
					{"Key" : "AGS", "Value" : "SPLUNK" , "PropagateAtLaunch" : "true" },
					{"Key" : "Group Name", "Value" : "OTRS Instance with AutoScaling" , "PropagateAtLaunch" : "true" },
					{"Key" : "SDLC", "Value" : "DEV" , "PropagateAtLaunch" : "true" },
                    {"Key" : "Cost Center", "Value" : "ISE901" , "PropagateAtLaunch" : "true" },
                    {"Key" : "Owner", "Value" : "Tom Hanks" , "PropagateAtLaunch" : "true" },
                    {"Key" : "Role", "Value" : "AutoScaling Group OTRS" , "PropagateAtLaunch" : "true" }]
		}
	},
		"LaunchConfig" : {
		"Type" : "AWS::AutoScaling::LaunchConfiguration",
			"Properties" : {
			"KeyName" : { "Ref" : "keyName" },
			"InstanceType" : { "Ref" : "instanceType" },
			"SecurityGroups" : { "Ref" : "securityGroups" },
			"IamInstanceProfile" : { "Ref" : "instanceProfile" },
			"ImageId" : { "Fn::FindInMap" : [ "AWSRegionArch2AMI", { "Ref" : "AWS::Region" },
						{ "Fn::FindInMap" : [ "AWSInstanceType2Arch", { "Ref" : "instanceType" }, "Arch" ] } ] },
		"UserData" : {
				"Fn::Base64" : {
					"Fn::Join" : ["",
					[
					"#!/bin/bash\n",
					"yum -y install mysql\n",
					"yum -y install httpd\n",
					"service httpd start\n",
					"echo 'CloudFormation Template Completed'> /var/tmp/Logs.txt"
					]
						]
				}
			}
		}
	},
		"OTRSScaleUpPolicy" : {
		"Type" : "AWS::AutoScaling::ScalingPolicy",
			"Properties" : {
			"AdjustmentType" : "ChangeInCapacity",
			"AutoScalingGroupName" : { "Ref" : "OTRSScalingGroup" },
			"Cooldown" : "60",
			"ScalingAdjustment" : "1"
			}
		},
		"OTRSScaleDownPolicy" : {
		"Type" : "AWS::AutoScaling::ScalingPolicy",
			"Properties" : {
			"AdjustmentType" : "ChangeInCapacity",
			"AutoScalingGroupName" : { "Ref" : "OTRSScalingGroup" },
			"Cooldown" : "60",
			"ScalingAdjustment" : "-1"
		}
		},
	    "CPUAlarmHigh": {
		"Type": "AWS::CloudWatch::Alarm",
			"Properties": {
			"AlarmDescription": "Scale-up if CPU > 70% for 10 minutes",
			"MetricName": "Splunk SearchHead CPUUtilization(s)",
			"Namespace": "AWS/EC2",
			"Statistic": "Average",
			"Period": "300",
			"EvaluationPeriods": "2",
			"Threshold": "70",
        "AlarmActions": [ { "Ref": "OTRSScaleUpPolicy" } ],
			"Dimensions": [
				{
					"Name": "Splunk AutoScaling-GroupName",
					"Value": { "Ref": "OTRSScalingGroup" }
				}
        ],
        "ComparisonOperator": "GreaterThanThreshold"
      }
    },
	    "CPUAlarmLow": {
		"Type": "AWS::CloudWatch::Alarm",
			"Properties": {
			"AlarmDescription": "Scale-down if CPU < 50% for 10 minutes",
			"MetricName": "CPUUtilization",
			"Namespace": "AWS/EC2",
			"Statistic": "Average",
			"Period": "300",
			"EvaluationPeriods": "2",
			"Threshold": "50",
        "AlarmActions": [ { "Ref": "OTRSScaleDownPolicy" } ],
			"Dimensions": [
				{
					"Name": "Splunk AutoScaling-GroupName",
					"Value": { "Ref": "OTRSScalingGroup" }
				}
        ],
        "ComparisonOperator": "LessThanThreshold"
      }
    }
},
	"Outputs": {
		"AutoScalingGroup" : {
		"Description" : "Auto Scaling Group Reference ID",
		"Value" : { "Ref" : "OTRSScalingGroup" }
		},
	"AutoScalingPolicy" : {
		"Description" : "Auto Scaling Policy Reference ID",
		"Value" : { "Ref" : "OTRSScaleUpPolicy" }
		}
	} 
}
